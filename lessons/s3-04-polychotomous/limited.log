------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/doylewr/practicum_2017/central/lessons/s3-04-polychotomous/limit
> ed.log
  log type:  text
 opened on:  17 Apr 2018, 12:56:16

. 
. /* Models for Limited and Count Variables*/
. /* Will Doyle */
. /* 2018-04-03 */
. 
. clear

. 
. clear mata /* Clears any fluff that might be in mata */

. 
. estimates clear /* Clears any estimates hanging around */

. 
. set more off /*Get rid of annoying "more" feature */

. 
. graph drop _all

. 
. global ddir "../../data/"

. 
. /*Controls*/
. 
. local coding=0

. local order_analysis=0

. local multi_analysis=1

. local multi_ses_race=0

. local auc=1

. local compare=1

. 
. /*Locals for analysis*/
. local y first_inst

. 
. local test bynels2m bynels2r

. 
. local race amind asian black hispanic multiracial

. 
. local pared bypared_nohs bypared_2yrnodeg bypared_2yr bypared_some4 bypared_master
> s bypared_phd 

. 
. local income  byses1

. 
. local plan_outcomes "No Plans" "CC/Votech" "Bachelors or More"

. 
. if `coding'==1{
. 
.   use "${ddir}plans.dta", clear
. 
. foreach myvar of varlist stu_id-f1psepln{ /* Start outer loop */
  2.               foreach i of numlist -4 -8 -9 { /* Start inner loop */
  3.                      replace `myvar'=. if `myvar'== `i'
  4.                                             }  /* End inner loop */
  5.                                           } /* End outer loop */
. 
. local race_names amind asian black hispanic_no hispanic_race multiracial white
. 
. tab(byrace), gen(race_)
. 
. local i=1
. 
. foreach val of local race_names{
  2.   rename race_`i' `val'
  3.   local i=`i'+1
  4. }
. 
. label variable byincome "Income"
. label variable amind "American Indian/AK Native"
. label variable asian "Asian/ PI"
. label variable black "African American"
. label variable white "White"
. label variable multiracial "Multiracial"
. 
. 
. gen hispanic=0
. replace hispanic=1 if hispanic_no==1|hispanic_race==1
. replace hispanic=. if byrace==.
. 
. label variable hispanic "Hispanic"
. 
. local plan_names noplan dontknow votech cc fouryr earlygrad
. 
. tab(f1psepln), gen(plan_)
. 
. local i=1
. 
. foreach val of local plan_names{
  2.   rename plan_`i' `val'
  3.   local i=`i'+1
  4. }
. 
. 
. label variable noplan "Plans: No plans"
. label variable dontknow "Plans: Don't know"
. label variable votech "Plans: Voc/Tech School"
. label variable cc "Plans: Comm Coll"
. label variable fouryr "Four Year"
. label variable earlygrad "Early Graduation"
. 
. /* Plans for those who have them */
. 
. gen order_plan=.
. replace order_plan=1 if noplan==1| dontknow==1
.   replace order_plan=2 if votech==1|cc==1
.   replace order_plan=3 if fouryr==1
. 
. label define orderplan 1 "No Plans/DK" 2 "Votech/CC" 3 "Four Year"
. 
.  label values order_plan orderplan
.   
. local pareds bymothed byfathed bypared
. 
. local ed_names nohs hs 2yrnodeg 2yr some4  4yrgrad masters phd
. 
. foreach pared of local pareds{
  2. 
. tab(`pared'), gen(`pared'_)
  3. 
. local i=1
  4. 
. foreach val of local ed_names{
  5.   rename `pared'_`i' `pared'_`val'
  6.   local i=`i'+1
  7. }
  8. 
. label variable `pared'_nohs "Less than HS"
  9. label variable `pared'_hs "HS/GED"
 10. label variable `pared'_2yr "CC" 
 11. label variable `pared'_some4 "Four year attend"
 12. label variable `pared'_4yrgrad "Bachelor's"
 13. label variable `pared'_masters "Master's"
 14. label variable `pared'_phd "PhD"
 15. }
. 
. tab bystexp,gen(exp_)
. 
. gen female=bysex==2
. replace female=. if bysex==.
. 
. replace bynels2m=bynels2m/100
. 
. replace bynels2r=bynels2r/100  
. 
. // recode bystexp
. 
. recode bystexp (-1/1=1) (2=2) (3/4=3) (5/7=4), gen(exp_new)
. 
. //drop _merge  
. 
. merge 1:1 stu_id using "${ddir}attend_type.dta" , nogen
. 
. //limited outcomes: number of applications and credits earned 
. 
. merge 1:1 stu_id using "${ddir}limited.dta"
. 
. foreach myvar of varlist f2ps1sec{ /* Start outer loop */
  2.               foreach i of numlist -3 -4 -8 -9 { /* Start inner loop */
  3.                      replace `myvar'=. if `myvar'== `i'
  4.                                             }  /* End inner loop */
  5.                                           } /* End outer loop */
. 
.   
. recode f2ps1sec (1=1) (2=2) (4=3) (3=4) (5/9=4), gen(first_inst)
. 
. replace first_inst=. if first_inst<0  
. 
.   label define sector 1 "Public 4 Year" 2 "Private 4 Year" 3 "Public 2 Year"  4 "O
> ther"
. 
.   label values first_inst sector
.   
.  tab first_inst f2ps1sec
.   
. save apps_credits.dta, replace
.   
. }

. 
. else{
.   use apps_credits.dta, clear 
.   }

. 
. 
. /*Analysis*/
. 
.   if `order_analysis'==1{
. reg order_plan female `test' `race' `pared' `income'
. 
. eststo oprob_1:oprobit order_plan female `test' 
. eststo oprob_2:oprobit order_plan female `test' `race' `pared' 
. eststo oprob_3:oprobit order_plan female `test' `race' `pared' `income'
. 
. esttab oprob_* using raw_oprobit.rtf, ///
>     not ///
>     nostar ///
>     b(2) ///
>     se(2) ///
>     aic ///
>     replace
. 
. local cut1=_b[cut1:_cons]
. local cut2=_b[cut2:_cons]
. 
. margins, predict(xb)  at(female=(0/1)) atmeans post /* Z in wooldridge*/
. 
. mat linpred=e(b)
. scalar male_pred=linpred[1,1]
. scalar female_pred=linpred[1,2]
.         
. graph twoway (function y=normalden(x,female_pred,1),range(-3 6)) ///
>              (function y=normalden(x,male_pred,1), range(-3 6)), ///
>              xline(`cut1',lpattern(dash)) /// 
>              xline(`cut2',lpattern(dash)) ///
>              legend(order(1 "LP for Women" 2 "LP for Men")) ///
>              note("") title("") ///
>              xtitle("Linear Prediction") ///
>              text(.3 -2 "No Plans", size(vsmall)) ///
>              text(.35 .9 "Votech/CC", size(vsmall)) ///
>              text(.3 4.2 "Four Year", size(vsmall))
.               
. graph export "linear.pdf", replace
. 
. estimates restore oprob_3
. 
.     margins ,at(female=(0/1)) predict(outcome(1)) atmeans
.     margins ,at(female=(0/1)) predict(outcome(2)) atmeans
.     margins ,at(female=(0/1)) predict(outcome(3)) atmeans
. 
. /*Marginal Effects*/
. 
.  estimates restore oprob_3
.  eststo marg1_ord:margins, dydx(`test' `race' `pared' `income') predict(outcome(1)
> ) post
.  estimates restore oprob_3
.  eststo marg2_ord:margins, dydx(`test' `race' `pared' `income') predict(outcome(2)
> ) post
.  estimates restore oprob_3
.  eststo marg3_ord:margins, dydx(`test' `race' `pared' `income') predict(outcome(3)
> ) post
. 
. esttab marg?_ord using marg_ord.rtf, ///
>     not ///
>     nostar ///
>     ci(2) ///
>     b(2) ///
>     replace    
. 
.         
. forvalues j= 1/3{
  2. 
. estimates restore oprob_3
  3. 
. margins,  predict(outcome(`j')) at(bynels2m=(.1 .2 .3 .4 .5 .6 .7) (min) `race' `p
> ared'  (mean) bynels2r byses1  )  post
  4. 
. // If you want to use marginsplot: 
. marginsplot, recastci(rarea) recast(line) name("outcome_`j'")
  5. 
. mat t=J(7,3,.) /* Empty matrix */
  6. 
. mat a = (.1\.2\.3\.4\.5\.6\.7)   /*"at values"*/
  7. 
. mat myb=r(b) /*Estimated marginal effects */
  8. mat myvc=r(V) /* variance/covariance */
  9. mat myvar=vecdiag(myvc) /* Variances of marginal effects */
 10. mat myse=J(1,7,.) /*Empty matrix for standard errors */
 11. 
. /*Sqrt of variances = standard errors */
.   
. forvalues i=1/7{
 12.   mat myse[1,`i']=sqrt(myvar[1,`i'])
 13. }
 14.   
. forvalues i=1/7 {
 15.   mat t[`i',1] = myb[1,`i']                      /*Probabilities */
 16.   mat t[`i',2] = myb[1,`i'] - 1.96*myse[1,`i']   /* Lower bound of ci */
 17.   mat t[`i',3] = myb[1,`i'] + 1.96*myse[1,`i']   /* Upper bound of ci */
 18. }
 19. 
. 
. mat t=t,a   /*Combine with "at" values */
 20. 
. mat li t
 21. 
. mat colnames t = prob ll ul at
 22. 
. svmat t, names(col) /*Converts matrix into data */
 23. 
. // local outcome `: word `j' of `plan_outcomes' '
. 
. twoway (rarea ll ul at,  fcolor(emidblue) fintensity(25) lwidth(none)  )(line prob
>  at), nodraw legend(off)  ///
>        xtitle("Math Score" ) ytitle("Pr y=m") title("Outcome=`j'") ///
>          yscale(range(0 1)) ylabel(0(.1)1)  scheme(s1color)
 24.          
. graph save "order_plan_`j'.gph", replace
 25. 
. drop prob ll ul at
 26. 
. }/*End loop over outcomes*/
. 
. graph combine order_plan_1.gph order_plan_2.gph order_plan_3.gph, ///
>   rows(1)
.   
. graph export  "order.pdf", replace
. 
. eststo exp_oprob_1: oprobit exp_new female `test' `race' `pared' `income'
. 
. forvalues j= 1/4{
  2. 
. estimates restore exp_oprob_1
  3. 
. margins, predict(outcome(`j')) at(bynels2m=(.1 .2 .3 .4 .5 .6 .7) (min) `race' `pa
> red'  (mean) bynels2r byses1  )  post
  4. 
. // If you want to use marginsplot: 
. marginsplot, recastci(rarea) recast(line) name("exp_outcome_`j'")
  5. 
. graph save "exp_outcome_`j'.gph", replace
  6. }
. 
. graph combine exp_outcome_1.gph exp_outcome_2.gph exp_outcome_3.gph exp_outcome_4.
> gph, ///
>   rows(1)
. 
. 
. /* Class exercise: work with student expectations */
. 
. } // End order analysis section

. 
. 
. /********************************************************************************/
. /* Multinomial Logit */
. /********************************************************************************/
>     
. 
. if `multi_analysis'==1{
. 
. eststo multi_plan:mlogit order_plan female `test' `race' `pared' `income', baseout
> come(1)

Iteration 0:   log likelihood = -10795.133  
Iteration 1:   log likelihood = -9221.2659  
Iteration 2:   log likelihood = -9137.4729  
Iteration 3:   log likelihood = -9136.7555  
Iteration 4:   log likelihood =  -9136.754  
Iteration 5:   log likelihood =  -9136.754  

Multinomial logistic regression                 Number of obs     =     13,055
                                                LR chi2(30)       =    3316.76
                                                Prob > chi2       =     0.0000
Log likelihood =  -9136.754                     Pseudo R2         =     0.1536

----------------------------------------------------------------------------------
      order_plan |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------+----------------------------------------------------------------
No_Plans_DK      |  (base outcome)
-----------------+----------------------------------------------------------------
Votech_CC        |
          female |   .7325832   .0788344     9.29   0.000     .5780705    .8870959
        bynels2m |   .5819859    .436177     1.33   0.182    -.2729053    1.436877
        bynels2r |    2.07375   .6194828     3.35   0.001     .8595856    3.287914
           amind |   -.605134   .3042908    -1.99   0.047    -1.201533    -.008735
           asian |   .4750685   .1597861     2.97   0.003     .1618936    .7882434
           black |   .4222754   .1237042     3.41   0.001     .1798197    .6647311
        hispanic |   .4378683    .109277     4.01   0.000     .2236894    .6520472
     multiracial |   -.096244   .1657339    -0.58   0.561    -.4210764    .2285885
    bypared_nohs |   .1302052   .1521141     0.86   0.392    -.1679329    .4283433
bypared_2yrnodeg |   .2427917   .1159521     2.09   0.036     .0155297    .4700537
     bypared_2yr |   .2158871    .119211     1.81   0.070    -.0177621    .4495363
   bypared_some4 |   .1325455   .1205133     1.10   0.271    -.1036563    .3687473
 bypared_masters |   .1403406    .181283     0.77   0.439    -.2149675    .4956488
     bypared_phd |   .3195829   .2624232     1.22   0.223    -.1947572    .8339229
          byses1 |   .1658802   .0727541     2.28   0.023     .0232848    .3084756
           _cons |   .0768846   .1597194     0.48   0.630    -.2361597    .3899289
-----------------+----------------------------------------------------------------
Four_Year        |
          female |   1.055537   .0781953    13.50   0.000     .9022767    1.208797
        bynels2m |   4.876855   .4302194    11.34   0.000      4.03364    5.720069
        bynels2r |   5.808207   .6077594     9.56   0.000     4.617021    6.999394
           amind |   .0680698   .2937803     0.23   0.817    -.5077291    .6438687
           asian |   1.126773   .1565305     7.20   0.000     .8199789    1.433567
           black |     1.3724   .1224412    11.21   0.000      1.13242     1.61238
        hispanic |   .5849156   .1115355     5.24   0.000     .3663099    .8035212
     multiracial |   .0161899   .1642255     0.10   0.921    -.3056862    .3380661
    bypared_nohs |   .3227711   .1584401     2.04   0.042     .0122342     .633308
bypared_2yrnodeg |   .0351962   .1162375     0.30   0.762    -.1926252    .2630176
     bypared_2yr |  -.0247986   .1185379    -0.21   0.834    -.2571286    .2075314
   bypared_some4 |   .0349397   .1183045     0.30   0.768    -.1969329    .2668123
 bypared_masters |   .2586525   .1728483     1.50   0.135    -.0801239    .5974288
     bypared_phd |   .2610459   .2524029     1.03   0.301    -.2336547    .7557465
          byses1 |   .8194727   .0720723    11.37   0.000     .6782137    .9607318
           _cons |  -2.446872   .1648982   -14.84   0.000    -2.770067   -2.123678
----------------------------------------------------------------------------------
. 
. 
. estimates restore multi_plan
(results multi_plan are active now)
. margins, dydx(`test' `race' `pared' `income') predict(outcome(1)) post

Average marginal effects                        Number of obs     =     13,055
Model VCE    : OIM

Expression   : Pr(order_plan==No_Plans_DK), predict(outcome(1))
dy/dx w.r.t. : bynels2m bynels2r amind asian black hispanic multiracial
               bypared_nohs bypared_2yrnodeg bypared_2yr bypared_some4
               bypared_masters bypared_phd byses1

----------------------------------------------------------------------------------
                 |            Delta-method
                 |      dy/dx   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------+----------------------------------------------------------------
        bynels2m |  -.1788909   .0256858    -6.96   0.000    -.2292341   -.1285477
        bynels2r |  -.2541269   .0368391    -6.90   0.000    -.3263302   -.1819236
           amind |   .0157471   .0171188     0.92   0.358    -.0178051    .0492992
           asian |  -.0514646   .0095934    -5.36   0.000    -.0702673   -.0326619
           black |   -.058032   .0073839    -7.86   0.000    -.0725042   -.0435598
        hispanic |  -.0324054   .0066283    -4.89   0.000    -.0453966   -.0194142
     multiracial |   .0023268   .0098044     0.24   0.812    -.0168896    .0215432
    bypared_nohs |  -.0145674   .0092013    -1.58   0.113    -.0326017    .0034669
bypared_2yrnodeg |   -.008389   .0069563    -1.21   0.228    -.0220232    .0052452
     bypared_2yr |  -.0056009   .0071261    -0.79   0.432    -.0195678    .0083661
   bypared_some4 |  -.0051007   .0071726    -0.71   0.477    -.0191587    .0089572
 bypared_masters |  -.0127446   .0107508    -1.19   0.236    -.0338157    .0083265
     bypared_phd |  -.0181562     .01573    -1.15   0.248    -.0489865    .0126741
          byses1 |  -.0320851   .0043098    -7.44   0.000    -.0405322    -.023638
----------------------------------------------------------------------------------
. estimates restore multi_plan
(results multi_plan are active now)
. margins, dydx(`test' `race' `pared' `income') predict(outcome(2)) post

Average marginal effects                        Number of obs     =     13,055
Model VCE    : OIM

Expression   : Pr(order_plan==Votech_CC), predict(outcome(2))
dy/dx w.r.t. : bynels2m bynels2r amind asian black hispanic multiracial
               bypared_nohs bypared_2yrnodeg bypared_2yr bypared_some4
               bypared_masters bypared_phd byses1

----------------------------------------------------------------------------------
                 |            Delta-method
                 |      dy/dx   Std. Err.      z    P>|z|     [95% Conf. Interval]
-----------------+----------------------------------------------------------------
        bynels2m |  -.5964872   .0418169   -14.26   0.000    -.6784467   -.5145276
        bynels2r |  -.4720171    .059743    -7.90   0.000    -.5891112    -.354923
           amind |  -.1142132   .0398042    -2.87   0.004     -.192228   -.0361984
           asian |  -.0790053   .0141406    -5.59   0.000    -.1067203   -.0512904
           black |  -.1232246   .0116972   -10.53   0.000    -.1461507   -.1002985
        hispanic |   -.007989   .0109716    -0.73   0.467    -.0294929     .013515
     multiracial |  -.0189317   .0176678    -1.07   0.284    -.0535598    .0156965
    bypared_nohs |   -.023647   .0168923    -1.40   0.162    -.0567553    .0094612
bypared_2yrnodeg |   .0368914   .0114907     3.21   0.001     .0143701    .0594127
     bypared_2yr |   .0408201   .0117171     3.48   0.000      .017855    .0637851
   bypared_some4 |   .0178925   .0116933     1.53   0.126    -.0050259    .0408108
 bypared_masters |  -.0127335   .0157151    -0.81   0.418    -.0435345    .0180675
     bypared_phd |   .0178732   .0209736     0.85   0.394    -.0232344    .0589807
          byses1 |  -.0884733   .0070826   -12.49   0.000    -.1023549   -.0745918
----------------------------------------------------------------------------------
. estimates restore multi_plan
(results multi_plan are active now)
