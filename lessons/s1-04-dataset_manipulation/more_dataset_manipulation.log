-------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/doylewr/practicum_2017/central/lessons/s1-04-dataset_manipulation
> /more_dataset_manipulation.log
  log type:  text
 opened on:  25 Sep 2017, 13:33:50

. 
. // NAME: More dataset manipulation
. // FILE: lecture5_more_dataset_manipulation.do
. // AUTH: Will Doyle
. // REVS: Benjamin Skinner
. // INIT: 17 September 2014
. // LAST: 25 September 2017
. 
. clear all                               // clear memory

. set more off                            // turn off annoying "__more__" feature

. 
. // set globals for url data link and local data path
. global urldata "https://stats.idre.ucla.edu/stat/stata/seminars/svy_stata_intro/api
> pop"

. 
. 
. // required Ado Files: onewayplot, mdesc, mvpatterns
. ssc install mdesc
checking mdesc consistency and verifying not already installed...
all files already exist and are up to date.

. ssc install onewayplot
checking onewayplot consistency and verifying not already installed...
all files already exist and are up to date.

. net install dm91, from ("http://www.stata.com/stb/stb61")
checking dm91 consistency and verifying not already installed...
all files already exist and are up to date.

.    
.    
.     use $urldata, clear

.         
.         save api, replace
(note: file api.dta not found)
file api.dta saved

.         
. // create example datasets
. preserve

. collapse (mean) api99, by(cnum)

. drawnorm county_inc, means(30) sds(5)

. sort cnum

. save county_data, replace
(note: file county_data.dta not found)
file county_data.dta saved

. restore

. 
. preserve

. collapse (mean) api99, by(dnum)

. rename api99 api99c

. gen edd = rbinomial(1,.3)

. save district_data, replace
(note: file district_data.dta not found)
file district_data.dta saved

. restore

. 
. // many-to-one match merging 
. 
. // sort to aid in merge
. sort cnum

. 
. // merge many-to-one
. merge m:1 cnum using county_data
(note: variable api99 was int, now float to accommodate using data's values)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                             6,194  (_merge==3)
    -----------------------------------------

. 
. // inspect many-to-one merge
. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
            matched (3) |      6,194      100.00      100.00
------------------------+-----------------------------------
                  Total |      6,194      100.00

. list cnum api99 county_inc if _n < 10

      +-------------------------+
      | cnum   api99   county~c |
      |-------------------------|
   1. |    1     693   27.79561 |
   2. |    1     589   27.79561 |
   3. |    1     572   27.79561 |
   4. |    1     732   27.79561 |
   5. |    1     784   27.79561 |
      |-------------------------|
   6. |    1     725   27.79561 |
   7. |    1     765   27.79561 |
   8. |    1     667   27.79561 |
   9. |    1     792   27.79561 |
      +-------------------------+

. 
. // plot and save
. onewayplot api99, by(county_inc) stack ms(oh) msize(*.1) width(1) name(api99_ow)

. graph export ${plotdir}api99_ow.eps, name(api99_ow) replace
(note: file api99_ow.eps not found)
(file api99_ow.eps written in EPS format)

. 
. // one-to-many match merging: but why?
. 
. use api, clear

. 
. // sort to aid in merge
. sort dnum

. 
. // save newly sorted dataset
. save api, replace
file api.dta saved

. 
. // load example data
. use district_data, clear

. 
. // sort to aid in merge
. sort dnum

. 
. // merge one-to-many
. merge 1:m dnum using api

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                             6,194  (_merge==3)
    -----------------------------------------

. 
. // inspect one-to-many merge
. tab _merge

                 _merge |      Freq.     Percent        Cum.
------------------------+-----------------------------------
            matched (3) |      6,194      100.00      100.00
------------------------+-----------------------------------
                  Total |      6,194      100.00

. list dnum api99 edd if _n < 10

      +--------------------+
      | dnum   api99   edd |
      |--------------------|
   1. |    1     491     1 |
   2. |    2     856     0 |
   3. |    3     760     1 |
   4. |    4     717     0 |
   5. |    5     669     1 |
      |--------------------|
   6. |    6     667     0 |
   7. |    7     857     1 |
   8. |   10     411     0 |
   9. |   12     782     0 |
      +--------------------+

. 
. // messy merge
. 
. use api, clear

. 
. preserve

. drop api00 ell mobility

. sample 90
(619 observations deleted)

. save api_99, replace
(note: file api_99.dta not found)
file api_99.dta saved

. restore

. 
. drop api99

. sample 90
(619 observations deleted)

. save api_00, replace
(note: file api_00.dta not found)
file api_00.dta saved

. 
. // merge datasets
. merge snum using api_99, sort
(note: you are using old merge syntax; see [D] merge for new syntax)
(label stype already defined)
(label sch_wide already defined)
(label comp_imp already defined)
(label both already defined)
(label awards already defined)
(label yr_rnd already defined)

. 
. // inspect messy merge
. tab _merge

     _merge |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |        562        9.16        9.16
          2 |        562        9.16       18.32
          3 |      5,013       81.68      100.00
------------+-----------------------------------
      Total |      6,137      100.00

. 
. // code for looking at missing values, other patterns
. 
. // command: inspect
. inspect api99

api99:                                          Number of Observations
--------                                    ------------------------------
                                            Total   Integers   Nonintegers
|          #                 Negative           -         -          -
|          #                 Zero               -         -          -
|      #   #   #             Positive        5575      5575          -
|      #   #   #                            -----     -----      -----
|      #   #   #             Total           5575      5575          -
|  #   #   #   #   #         Missing          562
+----------------------                     -----
302                 966                      6137
(More than 99 unique values)

. inspect api00

api00:                                          Number of Observations
--------                                    ------------------------------
                                            Total   Integers   Nonintegers
|          #                 Negative           -         -          -
|          #   #             Zero               -         -          -
|      #   #   #             Positive        5575      5575          -
|      #   #   #                            -----     -----      -----
|      #   #   #             Total           5575      5575          -
|  #   #   #   #   #         Missing          562
+----------------------                     -----
346                 969                      6137
(More than 99 unique values)

. 
. // command: mdesc
. mdesc api99 api00 

    Variable    |     Missing          Total     Percent Missing
----------------+-----------------------------------------------
          api99 |         562          6,137           9.16
          api00 |         562          6,137           9.16
----------------+-----------------------------------------------

. 
. // command: mvpatterns
. mvpatterns api99 api00 ell mobility
Variable     | type     obs   mv   variable label
-------------+----------------------------------------------
api99        | int     5575  562   
api00        | int     5575  562   
ell          | byte    5575  562   english language learners
mobility     | byte    5571  566   pct 1st year in school
------------------------------------------------------------

Patterns of missing values

  +------------------------+
  | _pattern   _mv   _freq |
  |------------------------|
  |     ++++     0    5009 |
  |     .+++     1     562 |
  |     +...     3     562 |
  |     +++.     1       4 |
  +------------------------+

. 
. // create flag if missing ell
. gen ell_flag = ell == .

. 
. // plot kernel density of api99 of observations missing ell
. kdensity api99 if ell_flag == 1, ///
>     name(api99_kdens) ///
>     addplot(kdensity api99 if ell_flag == 0) ///
>     legend(label(1 "Not Missing ELL")  label(2 "Missing ELL")) ///
>     note("") ///
>     title("")

. 
. graph export api99_kdens.eps, name(api99_kdens) replace
(note: file api99_kdens.eps not found)
(file api99_kdens.eps written in EPS format)

. 
. // reshaping: wide to long
. 
. // read in data and sort
. insheet using income.csv, comma clear
file income.csv not found
r(601);

end of do-file

r(601);

. cd "/Users/doylewr/practicum_2017/central/lessons/s1-05-more_dataset_manipulation"
/Users/doylewr/practicum_2017/central/lessons/s1-05-more_dataset_manipulation

. do "/Users/doylewr/practicum_2017/central/lessons/s1-05-more_dataset_manipulation/m
> ore_dataset_manipulation.do"

. capture log close                       // closes any logs, should they be open
